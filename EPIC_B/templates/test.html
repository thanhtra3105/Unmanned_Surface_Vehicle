<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USV Dashboard - Water Quality</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

    <style>
        /* Màu sắc chung */
        :root {
            --color-sidebar-bg: #0b1a29;
            --color-active: #00897b;
            /* Xanh ngọc lục bảo cho nút active */
            --color-text-dark: #2c3e50;
            --color-text-medium: #666;
            --color-background: #f4f7f9;
            --color-positive: #4caf50;
            --color-negative: #e53935;
            --color-sidebar-text: #c0c0c0;
        }

        /* Thiết lập cơ bản */
        body {
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background-color: var(--color-background);
            color: var(--color-text-dark);
            font-size: 14px;
            overflow-x: hidden;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background-color: var(--color-sidebar-bg);
            color: white;
            padding: 20px 0 10px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        }

        .logo {
            font-size: 24px;
            font-weight: 500;
            padding: 0 20px 40px;
            color: #4a90e2;
        }

        .sidebar-nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-nav li a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: var(--color-sidebar-text);
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .sidebar-nav li a:hover {
            background-color: #1a324a;
        }

        .sidebar-nav li.active a {
            background-color: var(--color-active);
            color: white;
            font-weight: 500;
        }

        .sidebar-nav i {
            margin-right: 15px;
            font-size: 1.1em;
            width: 20px;
        }

        .logout {
            padding: 20px;
            margin-top: auto;
            border-top: 1px solid #1a324a;
        }

        .logout a {
            color: var(--color-sidebar-text);
            text-decoration: none;
            display: flex;
            align-items: center;
        }

        /* Main Content */
        .main-content {
            flex-grow: 1;
            padding: 20px 40px;
            overflow-y: auto;
        }

        /* Top Bar */
        .top-bar {
            display: flex;
            align-items: center;
            padding: 5px 0;
            margin-bottom: 30px;
            color: var(--color-text-medium);
        }

        .menu-icon {
            font-size: 20px;
            margin-right: 20px;
            cursor: pointer;
            color: var(--color-text-dark);
        }

        .search-box input {
            padding: 10px 15px;
            width: 300px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background-color: white;
        }

        .user-actions {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 1.2em;
            cursor: pointer;
            color: var(--color-text-medium);
        }

        .avatar-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: #f06292;
            /* Màu hồng cho avatar */
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        /* Dashboard Header */
        .dashboard-header h1 {
            font-size: 24px;
            font-weight: 500;
            margin: 0;
            color: var(--color-text-dark);
        }

        .dashboard-header p {
            color: var(--color-text-medium);
            margin-top: 5px;
            margin-bottom: 30px;
            font-size: 14px;
        }

        /* Dashboard Grid: Bố cục 3 cột */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        /* Thiết lập span cho các thẻ lớn */
        .card-span-1-5 {
            grid-column: span 1.5;
        }

        .card-span-3 {
            grid-column: span 3;
        }

        .card-title {
            font-size: 14px;
            color: var(--color-text-medium);
            margin-bottom: 15px;
            font-weight: 400;
        }

        /* Center Cards (Battery & Speed) */
        .card-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            justify-content: center;
            padding: 30px 20px;
        }

        .gauge-display,
        .speed-display {
            font-size: 40px;
            font-weight: 500;
            color: var(--color-text-dark);
            line-height: 1.1;
        }

        .gauge-display .unit {
            font-size: 20px;
            margin-left: 5px;
            font-weight: normal;
            color: var(--color-positive);
        }

        .speed-display .unit {
            font-size: 20px;
            margin-left: 5px;
            font-weight: normal;
            color: var(--color-text-medium);
        }

        /* Parameter Cards (pH, DO, COD, TSS) */
        .parameter-card {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 100px;
        }

        .card-title-line {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        /* Custom Icon Colors */
        .icon-ph {
            color: #8bc34a;
        }

        .icon-do {
            color: #4fc3f7;
        }

        .icon-cod {
            color: #ff9800;
        }

        .icon-tss {
            color: #e91e63;
        }

        .parameter-value {
            font-size: 32px;
            font-weight: 500;
            color: var(--color-text-dark);
            line-height: 1.1;
            margin-top: 15px;
        }

        .unit-small {
            font-size: 14px;
            font-weight: normal;
            margin-left: 5px;
            color: var(--color-text-medium);
        }

        .parameter-change {
            font-size: 14px;
            margin-top: 5px;
        }

        .positive {
            color: var(--color-positive);
        }

        .negative {
            color: var(--color-negative);
        }

        /* --- History Card --- */
        .history-card {
            padding-bottom: 20px;
        }

        .history-card .card-title {
            font-size: 16px;
            font-weight: 500;
            color: var(--color-text-dark);
            margin-bottom: 5px;
        }

        .history-card .subtitle {
            font-size: 13px;
            color: var(--color-text-medium);
            margin-top: 0px;
            margin-bottom: 15px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            display: flex;
            flex-direction: column;
            padding-left: 50px;
            /* Không gian cho trục Y */
            padding-right: 20px;
        }

        /* Ẩn Canvas Chart.js */
        #qualityHistoryChart {
            display: none;
        }

        /* Mô phỏng Trục Y thủ công (bao gồm gridlines) */
        .chart-y-labels {
            position: absolute;
            top: 50px;
            left: 0;
            height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 14px;
            color: var(--color-text-dark);
            font-weight: 500;
            width: 50px;
            text-align: right;

            border-left: 1px solid #ddd;
        }

        .chart-y-labels span {
            position: relative;
            padding-right: 10px;
        }

        /* Thêm đường kẻ ngang bằng pseudo-element */
        .chart-y-labels span:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 0;
            /* Tính toán để đường kẻ ngang kéo dài ra hết card */
            width: 1000px;
            max-width: calc(100% + 100vw);
            height: 1px;
            background-color: #eee;
            z-index: 1;
        }

        /* Nhãn '0' không cần đường kẻ ngang */
        .chart-y-labels span:last-child::after {
            display: none;
        }


        /* Nhãn X (Thời gian) */
        .chart-x-labels {
            display: flex;
            justify-content: space-between;
            padding: 0;
            margin-top: 10px;
            color: var(--color-text-medium);
            font-size: 14px;
            font-weight: 500;
            border-top: 1px solid #ddd;
            /* Trục X */
            padding-top: 5px;
        }

        /* Căn chỉnh 00:00 và 24:00 (đẩy vào trong) */
        .chart-x-labels span:first-child {
            transform: translateX(-50%);
        }

        .chart-x-labels span:last-child {
            transform: translateX(50%);
        }

        /* Nhãn Tham số (COD, DO, TSS, pH) */
        .chart-parameter-labels {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 30px;
            font-size: 14px;
            color: var(--color-text-dark);
            font-weight: 500;
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="logo">AquaMonitor</div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="#"><i class="fa-solid fa-chart-line"></i> Overview</a></li>
                    <li><a href="#"><i class="fa-solid fa-water"></i> Water Quality</a></li>
                    <li><a href="#"><i class="fa-solid fa-ship"></i> Vessel Status</a></li>
                    <li><a href="#"><i class="fa-solid fa-chart-area"></i> Analytics</a></li>
                    <li class="active"><a href="#"><i class="fa-solid fa-gear"></i> Settings</a></li>
                </ul>
            </nav>
            <div class="logout">
                <a href="#"><i class="fa-solid fa-arrow-right-from-bracket"></i> Logout</a>
            </div>
        </aside>

        <main class="main-content">
            <header class="top-bar">
                <div class="menu-icon"><i class="fa-solid fa-bars"></i></div>
                <div class="search-box">
                    <input type="text" placeholder="Search or type command...">
                </div>
                <div class="user-actions">
                    <i class="fa-regular fa-bell"></i>
                    <i class="fa-solid fa-triangle-exclamation"></i>
                    <div class="avatar-icon">
                        <i class="fa-solid fa-user-tie"></i>
                    </div>
                </div>
            </header>

            <div class="dashboard-header">
                <h1>Water Quality Monitoring</h1>
                <p>Real-time monitoring of autonomous water quality vessel</p>
            </div>

            <section class="dashboard-grid">

                <div class="card card-center card-span-1-5">
                    <div class="card-title">Battery Level</div>
                    <div class="center-content">
                        <div class="gauge-display">
                            <span class="value"></span>
                            <span class="unit">%</span>
                        </div>
                    </div>
                </div>

                <div class="card card-center card-span-1-5">
                    <div class="card-title">Vessel Speed</div>
                    <div class="center-content">
                        <div class="speed-display">
                            <span class="value"></span>
                            <span class="unit">km/h</span>
                        </div>
                    </div>
                </div>

                <div class="card parameter-card">
                    <div class="card-title-line">
                        <div class="card-title">pH Level</div>
                        <i class="icon-ph fa-solid fa-leaf"></i>
                    </div>
                    <div class="parameter-value">7.2</div>
                    <div class="parameter-change positive">+0.1</div>
                </div>

                <div class="card parameter-card">
                    <div class="card-title-line">
                        <div class="card-title">Dissolved Oxygen</div>
                        <i class="icon-do fa-solid fa-stream"></i>
                    </div>
                    <div class="parameter-value">8.5<span class="unit-small">mg/L</span></div>
                    <div class="parameter-change negative">-0.3</div>
                </div>

                <div class="card parameter-card">
                    <div class="card-title-line">
                        <div class="card-title">COD</div>
                        <i class="icon-cod fa-solid fa-box"></i>
                    </div>
                    <div class="parameter-value">45<span class="unit-small">mg/L</span></div>
                    <div class="parameter-change positive">+5</div>
                </div>

                <div class="card parameter-card">
                    <div class="card-title-line">
                        <div class="card-title">TSS</div>
                        <i class="icon-tss fa-solid fa-wave-square"></i>
                    </div>
                    <div class="parameter-value">120<span class="unit-small">mg/L</span></div>
                    <div class="parameter-change negative">-10</div>
                </div>

                <div class="card history-card card-span-3">
                    <div class="card-title">Water Quality History</div>
                    <p class="subtitle">24-hour monitoring data</p>
                    <div class="chart-container">
                        <div class="chart-y-labels">
                            <span>140</span>
                            <span>105</span>
                            <span>70</span>
                            <span>35</span>
                            <span>0</span>
                        </div>
                        <canvas id="qualityHistoryChart"></canvas>

                        <div class="chart-parameter-labels">
                            <span>COD</span>
                            <span>DO</span>
                            <span>TSS</span>
                            <span>pH</span>
                        </div>
                        <div class="chart-x-labels">
                            <span>00:00</span>
                            <span>04:00</span>
                            <span>08:00</span>
                            <span>12:00</span>
                            <span>16:00</span>
                            <span>20:00</span>
                            <span>24:00</span>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Các biến toàn cục cho các biểu đồ cần được giữ lại
        let qualityHistoryChart;

        // =================================================================
        // 1. KHỞI TẠO BIỂU ĐỒ (Chỉ giữ lại Biểu đồ Lịch sử Chất lượng Nước)
        // =================================================================

        function initializeCharts() {
            // Khởi tạo Biểu đồ Lịch sử Chất lượng Nước
            qualityHistoryChart = new Chart(document.getElementById("qualityHistoryChart"), {
                type: 'line',
                data: {
                    labels: [], datasets: [
                        { label: "pH", data: [], borderColor: "#8bc34a", fill: false, yAxisID: 'yPH' },
                        { label: "DO (mg/L)", data: [], borderColor: "#4fc3f7", fill: false, yAxisID: 'yDO' },
                        { label: "COD (mg/L)", data: [], borderColor: "#ff9800", fill: false, yAxisID: 'yCOD_TSS' },
                        { label: "TSS (mg/L)", data: [], borderColor: "#e91e63", fill: false, yAxisID: 'yCOD_TSS' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Time' } },

                        // Trục Y cho pH (0-14, bên trái)
                        yPH: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            min: 6.5, // Phạm vi hẹp hơn cho trực quan tốt hơn
                            max: 8.5,
                            title: { display: true, text: 'pH' }
                        },
                        // Trục Y cho DO (0-20, bên phải)
                        yDO: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: 0,
                            max: 15,
                            grid: { drawOnChartArea: false },
                            title: { display: true, text: 'DO (mg/L)' }
                        },
                        // Trục Y dùng chung cho COD/TSS (có thể ẩn nếu quá rối)
                        yCOD_TSS: {
                            type: 'linear',
                            display: false, // Ẩn trục này
                            position: 'right',
                            min: 0,
                            max: 150, // Ví dụ max 150
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
            // Hiển thị canvas và ẩn các nhãn Y/X thủ công sau khi Chart.js đã khởi tạo
            document.getElementById("qualityHistoryChart").style.display = 'block';
            document.querySelector(".chart-y-labels").style.display = 'none';
            document.querySelector(".chart-x-labels").style.display = 'none';
            document.querySelector(".chart-parameter-labels").style.display = 'none';
        }

        // =================================================================
        // 2. CẬP NHẬT GIAO DIỆN HTML (Cards)
        // =================================================================

        function updateCard(title, value, unit, change, status) {
            // Tìm thẻ dựa trên tiêu đề, đơn giản hóa bằng cách sử dụng Query Selector
            const cardElement = Array.from(document.querySelectorAll('.parameter-card .card-title')).find(el => el.textContent.trim() === title)?.closest('.parameter-card');

            if (cardElement) {
                // Cập nhật giá trị chính
                const valueEl = cardElement.querySelector('.parameter-value');
                valueEl.innerHTML = `${value}${unit ? `<span class="unit-small">${unit}</span>` : ''}`;

                // Cập nhật sự thay đổi
                const changeEl = cardElement.querySelector('.parameter-change');
                if (changeEl) {
                    // Định dạng dấu '+'
                    changeEl.textContent = (change > 0 ? '+' : '') + change;

                    // Cập nhật màu sắc
                    changeEl.classList.remove('positive', 'negative');
                    if (status === 'positive') {
                        changeEl.classList.add('positive');
                    } else if (status === 'negative') {
                        changeEl.classList.add('negative');
                    }
                }
            }
        }

        // =================================================================
        // 3. FETCH DATA VÀ CẬP NHẬT
        // =================================================================

        async function fetchTelemetry() {
            try {
                

                // --- Dữ liệu giả định nếu không có API thật để test ---
                
                // let data = {
                //     success: true,
                //     telemetry: {
                //         battery: Math.floor(Math.random() * (95 - 75 + 1)) + 75,
                //         speed: (Math.random() * (15 - 10) + 10).toFixed(1),
                //         ph: (Math.random() * (7.5 - 6.8) + 6.8).toFixed(1),
                //         do: (Math.random() * (9.0 - 7.5) + 7.5).toFixed(1),
                //         cod: Math.floor(Math.random() * (60 - 30 + 1)) + 30,
                //         tss: Math.floor(Math.random() * (130 - 100 + 1)) + 100,
                //         ph_change: (Math.random() * 0.5 - 0.25).toFixed(1),
                //         do_change: (Math.random() * 0.5 - 0.25).toFixed(1),
                //         cod_change: Math.floor(Math.random() * 10) - 5,
                //         tss_change: Math.floor(Math.random() * 10) - 5
                //     }
                // };
                
                // --- Kết thúc Dữ liệu giả định ---

                // *** THAY THẾ BẰNG ENDPOINT API THỰC TẾ CỦA BẠN ***
                let res = await fetch("/api/telemetry");
                let data = await res.json();

                if (data.success) {
                    let t = data.telemetry;

                    // A. Cập nhật Battery & Speed (sử dụng HTML cards)
                    document.querySelector('.gauge-display .value').textContent = t.battery;
                    document.querySelector('.speed-display .value').textContent = t.speed;

                    // B. Cập nhật Water Quality Parameter Cards
                    // (Giả sử API trả về các trường 'change' và 'status' hoặc ta tính toán thủ công)
                    // Ở đây tôi dùng t.ph_change và t.do_change giả định.
                    updateCard('pH Level', t.ph, null, t.ph_change || 0, t.ph_change >= 0 ? 'positive' : 'negative');
                    updateCard('Dissolved Oxygen', t.do, 'mg/L', t.do_change || 0, t.do_change >= 0 ? 'positive' : 'negative');
                    updateCard('COD', t.cod, 'mg/L', t.cod_change || 0, t.cod_change >= 0 ? 'positive' : 'negative');
                    updateCard('TSS', t.tss, 'mg/L', t.tss_change || 0, t.tss_change >= 0 ? 'positive' : 'negative');


                    // C. Cập nhật Biểu đồ Lịch sử (Chart.js)
                    let ts = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });

                    qualityHistoryChart.data.labels.push(ts);
                    qualityHistoryChart.data.datasets[0].data.push(t.ph); // pH
                    qualityHistoryChart.data.datasets[1].data.push(t.do); // DO
                    qualityHistoryChart.data.datasets[2].data.push(t.cod); // COD
                    qualityHistoryChart.data.datasets[3].data.push(t.tss); // TSS

                    const MAX_POINTS = 20; // Giữ 20 điểm dữ liệu gần nhất
                    if (qualityHistoryChart.data.labels.length > MAX_POINTS) {
                        qualityHistoryChart.data.labels.shift();
                        qualityHistoryChart.data.datasets.forEach(ds => ds.data.shift());
                    }

                    qualityHistoryChart.update();
                }
            } catch (e) {
                console.error("Fetch telemetry failed:", e);
                // Hiển thị trạng thái lỗi
                document.querySelector('.gauge-display .value').textContent = "---";
                document.querySelector('.speed-display .value').textContent = "---";
            }
        }

        // =================================================================
        // 4. KHỞI CHẠY
        // =================================================================

        document.addEventListener('DOMContentLoaded', function () {
            initializeCharts();
            fetchTelemetry();
            setInterval(fetchTelemetry, 5000); // Fetch data mỗi 5 giây
        });
    </script>
</body>

</html>