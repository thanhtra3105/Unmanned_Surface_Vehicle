<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Upload Mission</title>
</head>
<body>
  <h3>Upload Mission to USV</h3>
  <input type="file" id="fileInput" accept=".json">
  <button id="uploadBtn">Upload</button>
  <div id="status"></div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const status = document.getElementById('status');

    uploadBtn.addEventListener('click', async () => {
      const file = fileInput.files[0];
      if (!file) { alert('Chọn mission.json trước'); return; }

      const text = await file.text();
      let missionObj;
      try {
        missionObj = JSON.parse(text);
      } catch (e) {
        alert('File JSON sai định dạng');
        return;
      }

      status.innerText = 'Uploading...';

      try {
        const res = await fetch('/upload-mission', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(missionObj)
        });
        const j = await res.json();

        if (res.ok && j.success) {
          status.innerText = 'Upload success: ' + j.message;
          // xóa queue nếu có
          clearQueuedMission(file.name);
        } else {
          status.innerText = 'Upload failed: ' + (j.message || 'no message');
          // lưu vào queue (offline handling)
          queueMission(file.name, missionObj);
        }
      } catch (err) {
        status.innerText = 'Network error: saved to queue.';
        queueMission(file.name, missionObj);
      }
    });

    // Queue logic using localStorage
    const QUEUE_KEY = 'mission_upload_queue';

    function queueMission(name, missionObj) {
      const queue = JSON.parse(localStorage.getItem(QUEUE_KEY) || '[]');
      queue.push({name, missionObj, ts: Date.now()});
      localStorage.setItem(QUEUE_KEY, JSON.stringify(queue));
    }

    function clearQueuedMission(name) {
      let queue = JSON.parse(localStorage.getItem(QUEUE_KEY) || '[]');
      queue = queue.filter(item => item.name !== name);
      localStorage.setItem(QUEUE_KEY, JSON.stringify(queue));
    }

    // Retry loop: try to resend every 30s
    setInterval(async () => {
      const queue = JSON.parse(localStorage.getItem(QUEUE_KEY) || '[]');
      if (queue.length === 0) return;
      status.innerText = 'Retrying queued missions...';
      for (let i = 0; i < queue.length; i++) {
        const entry = queue[i];
        try {
          const res = await fetch('/upload-mission', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(entry.missionObj)
          });
          const j = await res.json();
          if (res.ok && j.success) {
            status.innerText = `Queued ${entry.name} uploaded OK`;
            clearQueuedMission(entry.name);
          } else {
            console.warn('Retry failed:', j);
          }
        } catch (e) {
          console.warn('Retry network error', e);
        }
      }
    }, 30000);
  </script>
</body>
</html>
